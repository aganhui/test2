---
{"dg-publish":true,"permalink":"/01-diary//v0-1/","title":"Untitled 7"}
---


1. [1 整体设计](#1%20%E6%95%B4%E4%BD%93%E8%AE%BE%E8%AE%A1)
	1. [1.1 系统架构](#1.1%20%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84)
	1. [1.2 工作流示例](#1.2%20%E5%B7%A5%E4%BD%9C%E6%B5%81%E7%A4%BA%E4%BE%8B)
1. [2 任务项](#2%20%E4%BB%BB%E5%8A%A1%E9%A1%B9)
	1. [2.1 现有问题](#2.1%20%E7%8E%B0%E6%9C%89%E9%97%AE%E9%A2%98)
		1. [2.1.1 部署](#2.1.1%20%E9%83%A8%E7%BD%B2)
			1. [2.1.1.1 节点是否需要复用原有资源的问题 2️⃣](#2.1.1.1%20%E8%8A%82%E7%82%B9%E6%98%AF%E5%90%A6%E9%9C%80%E8%A6%81%E5%A4%8D%E7%94%A8%E5%8E%9F%E6%9C%89%E8%B5%84%E6%BA%90%E7%9A%84%E9%97%AE%E9%A2%98%202%EF%B8%8F%E2%83%A3)
		1. [2.1.2 流程编排](#2.1.2%20%E6%B5%81%E7%A8%8B%E7%BC%96%E6%8E%92)
			1. [2.1.2.1 图形和文本如何进行转换问题 1️⃣](#2.1.2.1%20%E5%9B%BE%E5%BD%A2%E5%92%8C%E6%96%87%E6%9C%AC%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E8%BD%AC%E6%8D%A2%E9%97%AE%E9%A2%98%201%EF%B8%8F%E2%83%A3)
			1. [2.1.2.2 编辑工作流是否需要对节点重新进行资源定义](#2.1.2.2%20%E7%BC%96%E8%BE%91%E5%B7%A5%E4%BD%9C%E6%B5%81%E6%98%AF%E5%90%A6%E9%9C%80%E8%A6%81%E5%AF%B9%E8%8A%82%E7%82%B9%E9%87%8D%E6%96%B0%E8%BF%9B%E8%A1%8C%E8%B5%84%E6%BA%90%E5%AE%9A%E4%B9%89)
			1. [2.1.2.3 是否需要对函数流定义输入输出参数](#2.1.2.3%20%E6%98%AF%E5%90%A6%E9%9C%80%E8%A6%81%E5%AF%B9%E5%87%BD%E6%95%B0%E6%B5%81%E5%AE%9A%E4%B9%89%E8%BE%93%E5%85%A5%E8%BE%93%E5%87%BA%E5%8F%82%E6%95%B0)
			1. [2.1.2.4 工作流嵌套 1️⃣](#2.1.2.4%20%E5%B7%A5%E4%BD%9C%E6%B5%81%E5%B5%8C%E5%A5%97%201%EF%B8%8F%E2%83%A3)
			1. [2.1.2.5 是否支持不同节点类型 3️⃣](#2.1.2.5%20%E6%98%AF%E5%90%A6%E6%94%AF%E6%8C%81%E4%B8%8D%E5%90%8C%E8%8A%82%E7%82%B9%E7%B1%BB%E5%9E%8B%203%EF%B8%8F%E2%83%A3)
		1. [2.1.3 运行](#2.1.3%20%E8%BF%90%E8%A1%8C)
			1. [2.1.3.1 基于事件触发机制进行触发调用，支持不同类型 2️⃣3️⃣](#2.1.3.1%20%E5%9F%BA%E4%BA%8E%E4%BA%8B%E4%BB%B6%E8%A7%A6%E5%8F%91%E6%9C%BA%E5%88%B6%E8%BF%9B%E8%A1%8C%E8%A7%A6%E5%8F%91%E8%B0%83%E7%94%A8%EF%BC%8C%E6%94%AF%E6%8C%81%E4%B8%8D%E5%90%8C%E7%B1%BB%E5%9E%8B%202%EF%B8%8F%E2%83%A33%EF%B8%8F%E2%83%A3)
			1. [2.1.3.2 目前没有节点的运行日志 1️⃣](#2.1.3.2%20%E7%9B%AE%E5%89%8D%E6%B2%A1%E6%9C%89%E8%8A%82%E7%82%B9%E7%9A%84%E8%BF%90%E8%A1%8C%E6%97%A5%E5%BF%97%201%EF%B8%8F%E2%83%A3)
			1. [2.1.3.3 工作流执行日志格式和内容不全 1️⃣](#2.1.3.3%20%E5%B7%A5%E4%BD%9C%E6%B5%81%E6%89%A7%E8%A1%8C%E6%97%A5%E5%BF%97%E6%A0%BC%E5%BC%8F%E5%92%8C%E5%86%85%E5%AE%B9%E4%B8%8D%E5%85%A8%201%EF%B8%8F%E2%83%A3)
		1. [2.1.4 观测](#2.1.4%20%E8%A7%82%E6%B5%8B)
			1. [2.1.4.1 暂无观测方案，需要考虑资源是复用还是独占，如果是复用有可能无法区分流量来源问题 3️⃣](#2.1.4.1%20%E6%9A%82%E6%97%A0%E8%A7%82%E6%B5%8B%E6%96%B9%E6%A1%88%EF%BC%8C%E9%9C%80%E8%A6%81%E8%80%83%E8%99%91%E8%B5%84%E6%BA%90%E6%98%AF%E5%A4%8D%E7%94%A8%E8%BF%98%E6%98%AF%E7%8B%AC%E5%8D%A0%EF%BC%8C%E5%A6%82%E6%9E%9C%E6%98%AF%E5%A4%8D%E7%94%A8%E6%9C%89%E5%8F%AF%E8%83%BD%E6%97%A0%E6%B3%95%E5%8C%BA%E5%88%86%E6%B5%81%E9%87%8F%E6%9D%A5%E6%BA%90%E9%97%AE%E9%A2%98%203%EF%B8%8F%E2%83%A3)
	1. [2.2 补充](#2.2%20%E8%A1%A5%E5%85%85)
		1. [2.2.1 系统架构 1️⃣](#2.2.1%20%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%201%EF%B8%8F%E2%83%A3)
		1. [2.2.2 运行环境 ❤️](#2.2.2%20%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83%20%E2%9D%A4%EF%B8%8F)
		1. [2.2.3 云函数](#2.2.3%20%E4%BA%91%E5%87%BD%E6%95%B0)
			1. [2.2.3.1 代码自动识别 ❤️](#2.2.3.1%20%E4%BB%A3%E7%A0%81%E8%87%AA%E5%8A%A8%E8%AF%86%E5%88%AB%20%E2%9D%A4%EF%B8%8F)
			1. [2.2.3.2 制定通用的数据传输结构，开发数据格式转换器 ❤️](#2.2.3.2%20%E5%88%B6%E5%AE%9A%E9%80%9A%E7%94%A8%E7%9A%84%E6%95%B0%E6%8D%AE%E4%BC%A0%E8%BE%93%E7%BB%93%E6%9E%84%EF%BC%8C%E5%BC%80%E5%8F%91%E6%95%B0%E6%8D%AE%E6%A0%BC%E5%BC%8F%E8%BD%AC%E6%8D%A2%E5%99%A8%20%E2%9D%A4%EF%B8%8F)
			1. [2.2.3.3 云函数的配置文本化 1️⃣](#2.2.3.3%20%E4%BA%91%E5%87%BD%E6%95%B0%E7%9A%84%E9%85%8D%E7%BD%AE%E6%96%87%E6%9C%AC%E5%8C%96%201%EF%B8%8F%E2%83%A3)
		1. [2.2.4 工作流](#2.2.4%20%E5%B7%A5%E4%BD%9C%E6%B5%81)
			1. [2.2.4.1 节点之间的依赖关系需要制定标准 2️⃣](#2.2.4.1%20%E8%8A%82%E7%82%B9%E4%B9%8B%E9%97%B4%E7%9A%84%E4%BE%9D%E8%B5%96%E5%85%B3%E7%B3%BB%E9%9C%80%E8%A6%81%E5%88%B6%E5%AE%9A%E6%A0%87%E5%87%86%202%EF%B8%8F%E2%83%A3)
			1. [2.2.4.2 工作流任务进度](#2.2.4.2%20%E5%B7%A5%E4%BD%9C%E6%B5%81%E4%BB%BB%E5%8A%A1%E8%BF%9B%E5%BA%A6)
	1. [2.3 讨论后补充](#2.3%20%E8%AE%A8%E8%AE%BA%E5%90%8E%E8%A1%A5%E5%85%85)
		1. [2.3.1 debug](#2.3.1%20debug)
1. [3 Phase 1️⃣](#3%20Phase%201%EF%B8%8F%E2%83%A3)
1. [4 Phase 2️⃣](#4%20Phase%202%EF%B8%8F%E2%83%A3)
1. [5 Phase 3️⃣](#5%20Phase%203%EF%B8%8F%E2%83%A3)


___

| 任务项             | 状态 | 工作量 | 周期 | 方案    | 
| ------------------ |:----:| ------ | ---- | --- |
| **系统架构更改**   | 调研 | 大     | 1-0  | [[01-Diary/本周事务/工作流整体架构设计-v0.2\|工作流整体架构设计-v0.2]]    |
| 云函数多版本       | 调研 | 大     | 1-1  |     |
| 云函数复用         | 开启 | 大     | 1-2  | [[01-Diary/本周事务/工作流复用已有云函数-v0.1\|工作流复用已有云函数-v0.1]]    |
| **工作流嵌套**     | 开启 | 大     | 1️-1 | [[01-Diary/本周事务/工作流嵌套方案-v0.1\|工作流嵌套方案-v0.1]]    |
| 工作流级日志标准化 | 开启 | 小     | 1️-1 |     |
| 函数级日志         | 调研 |        | 1️-2 | [[01-Diary/本周事务/工作流云函数日志收集-v0.1\|工作流云函数日志收集-v0.1]]     |

| 任务项                      | 状态 | 工作量 | 周期 |
| --------------------------- | :----: | ------ | ---- |
| 工作流图形与文本转换        |  开启  | 中     | 2-x  |
| 资源观测                    |  调研  |        | 2-x  |
| 结点之间的多种依赖关系      |  调研  | 中     | 2️-x |
| 触发器                      |  调研  |        | 2️-x |
| 工作流级进度可视化          |  开启  | 中     | 2️-x |
| 不同节点类型                |  调研  |        | 3️-x |
| 云函数配置文本化            |  调研  | 小     | ❤️   |
| 运行环境                    |  调研  | 极大   | ❤️   |
| 通用数据格式+数据格式转换器 |  调研  | 大     | ❤️   |
| 自动识别代码                |  调研  | 大     | ❤️   |
| 函数级进度可视化            |  调研  | 大     | ❤️   |


# 1 整体设计
## 1.1 系统架构
![Pasted image 20230707154034.png|inline](/src/site/img/user/08-Assets/Pasted%20image%2020230707154034.png)![Pasted image 20230707162441.png|inline](/src/site/img/user/08-Assets/Pasted%20image%2020230707162441.png)
【各个模块在哪里运行（1、用户资源2、平台资源）（argo、istio）】


## 1.2 工作流示例
![Pasted image 20230707124222.png|500](/src/site/img/user/08-Assets/Pasted%20image%2020230707124222.png)

# 2 任务项
## 2.1 现有问题
### 2.1.1 部署
#### 2.1.1.1 节点是否需要复用原有资源的问题 2️⃣
复用指的是
1. 单一用户空间下工作流之间复用云函数
2. 所有用户空间下工作流之间复用云函数

1. 复用
	1. 编辑工作流不需要重新配置云函数的资源
	2. 整个系统的资源利用率更高
	3. 请求集中，可以充分利用云函数框架的扩缩容机制
	4. 有利于充分发挥pipeline优势
2. 不复用（当前版本，工作流即命名空间）
	1. 资源控制更方便
	2. 便于日志收集
	3. 便于资源监控
	4. 开发更简单？

工作量
1. 复用 
	1. 将每个请求的**日志**区分开【easy】
	2. 将每个请求所消耗的**资源**区分开
	3. 在编辑工作流时指定云函数的版本，云函数的配置只读，若需要更改云函数的配置，需要跳转到云函数编辑界面新建版本【用户界面要支持，后端根据版本冷启动实例】
	4. 支持运行多个版本的云函数，并且支持0副本【调研】
2. 不复用
	1. 编辑工作流的时候需要配置工作流的资源，或者逐一配置云函数的资源
	2. 在部署工作流的时候就将所有云函数部署好，或者等工作流触发后再逐一启动云函数实例。

watchdog 处理请求
efk 

### 2.1.2 流程编排
#### 2.1.2.1 图形和文本如何进行转换问题 1️⃣
1. 图形to文本【需要yaml文件解析和编辑的库，不做大幅度更改，只是增减某些行】
2. 文本to图形【后端根据文本解析成dag，与现有dag做对比，向前端发送图修改操作，由前端决定具体如何修改图结构】【位置确定规则】【图自动排版】

#### 2.1.2.2 编辑工作流是否需要对节点重新进行资源定义 
若复用云函数，则不需要重新定义资源
若不复用云函数，则需要重新定义资源

#### 2.1.2.3 是否需要对函数流定义输入输出参数 
将函数流抽象为函数，也同样有输入和输出

#### 2.1.2.4 工作流嵌套 1️⃣
工作流里面也可以有工作流，使用方法与函数没有很大区别
工作流也有版本，工作流嵌套时可以选择子工作流的版本
通过工作流嵌套可以实现多人协同开发工作流

前端：
1. 工作流工作区也要有工作流库，可以拖拽进来
2. 工作流节点的显示可以Fold/Unfold
3. 工作流任务显示问题：一个工作流运行会触发多个工作流任务，每个工作流都能显示总体进度，也能将工作流展开（显示工作流日志、云函数进度、云函数日志）
4. 子工作流只读，若更改需要跳转到子工作流编辑页面新建版本
后端：
1. 工作流数据结构中有工作流字段，可以引用其它工作流id
2. 将前端dag转为后端实际执行的dag时，需要将嵌套的工作流中的函数融合到最后的工作流中⭐【后续升级】

#### 2.1.2.5 是否支持不同节点类型 3️⃣
不同的节点类型在实现所定义的功能的方式上存在差异，包括云函数、sql命令、shell脚本、微服务【调研】

需要实现多样的工厂模式（不同调用策略）

### 2.1.3 运行
#### 2.1.3.1 基于事件触发机制进行触发调用，支持不同类型 2️⃣3️⃣
事件-触发机制的应用场景非常广泛，它可以使得整个系统松耦合。一个事件的消费端只有一个吗？？

此机制包含两端，事件生产端和事件消费端。
事件生产可以源于用户代码，也可以是系统代码(包括数据库)，也可以是用户在工作流上的设置
事件消费端可以是工作流，也可以是云函数，也可以是工作流中的云函数

修改：
在系统中添加事件和触发器这两个概念（都位于用户空间，是否需要区分公共事件和私有事件？？）
前端：
1. 需要添加事件库和触发器库这两个模块
2. 在云函数编辑页面可以为函数触发绑定触发器，函数完成可以发送事件，可以标记函数内会发送事件【自动识别】
3. 在工作流编辑页面可以为工作流触发绑定触发器，可以为工作流中的函数绑定触发器。工作流完成可以发送事件，节点完成可以发送事件
后端：
1. 开发触发器后端服务

#### 2.1.3.2 目前没有节点的运行日志 1️⃣
运行日志包括标准输出日志，以及日志文件

需要参考云原生开源日志收集框架EFK

#### 2.1.3.3 工作流执行日志格式和内容不全 1️⃣
制定工作流日志的统一标准，并且据此开发工作流日志库

### 2.1.4 观测
#### 2.1.4.1 暂无观测方案，需要考虑资源是复用还是独占，如果是复用有可能无法区分流量来源问题 3️⃣
观测对象包括各种资源（如cpu，gpu，内存，硬盘），粒度需要细化到请求级

需要参考观测框架（如**Prometheus**，**Jaeger**，**OpenTelemetry**）

## 2.2 补充
### 2.2.1 系统架构 1️⃣
1. 将各个功能模块划分开，设计好接口
2. 支持多工作流引擎
3. 

### 2.2.2 运行环境 ❤️ 
将运行环境与云函数分离，创建运行环境库
用户在创建云函数的时候可以选择运行环境及其版本。
运行环境包括功能函数运行所需的所有环境，从底层到上层包括：cpu，内存，硬盘挂载，docker，wasm，代码库，中间件，全局变量。。。
运行环境配置可以文本化，基础运行环境也可以复用。

1. 从用户角度，运行环境定义与功能定义分离可以提高运行环境的复用程度，使得云函数的开发更加简易。2️⃣
2. 从后端技术角度，运行环境定义与功能定义分离可以做到运行环境的复用，可以降低冷启动的时间，对运行环境统一管理 3️⃣

【成熟方案】
【durgonfly - nydus】

【aws】

### 2.2.3 云函数
#### 2.2.3.1 代码自动识别 ❤️
拥有语义级的代码识别能力（包括功能描述，输入输出结构，路由定义）

【识别能力】
【一对一路由，允许自定义路由，aws，阿里云】

#### 2.2.3.2 制定通用的数据传输结构，开发数据格式转换器 ❤️
主旨：用户，数据结构自由【自由范围】

【数据打包、统一结构】
【通用数据结构】
【用户自定义转换器】

#### 2.2.3.3 云函数的配置文本化 1️⃣
面向用户
面向系统
组件与其它平台兼容

【暂定】

### 2.2.4 工作流
#### 2.2.4.1 节点之间的依赖关系需要制定标准 2️⃣
顺序依赖

数据依赖 1️⃣

条件依赖（if-else, error分支, ）



#### 2.2.4.2 工作流任务进度 
工作流级进度图形化显示 2️⃣
函数级进度 ❤️

【粒度】
【系统识别，用户协调】
【~~智能强化~~】


## 2.3 讨论后补充
### 2.3.1 debug
（用户控制结点的单步执行，调研业界）

⭐
前端反馈
【邵鹤群】

# 3 Phase 1️⃣
拆分模块，制定接口

细节可调研

# 4 Phase 2️⃣

# 5 Phase 3️⃣

