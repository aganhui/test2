---
{"dg-publish":true,"permalink":"/01-diary//v0-1/","title":"工作流整体架构设计-v0.1","tags":["gardenEntry"]}
---


# 1 Background
要实现工作流整体功能，需要实现一个复杂的系统，这系统中有各个模块，分别实现各自的功能。需要考虑如何设计其整体架构和接口，以实现高度的松耦合和可拓展性。

![Pasted image 20230707154034.png|inline](/img/user/08-Assets/Pasted%20image%2020230707154034.png)![Pasted image 20230707162441.png|inline](/img/user/08-Assets/Pasted%20image%2020230707162441.png)

# 2 各层功能
## 2.1 用户层
### 2.1.1 工作流管理模块
1. 负责工作流管理，包括工作流的创建、编辑、删除
2. 负责工作流记录管理，包括工作流记录的创建，查看状态/进度，查看日志，删除记录

#### 2.1.1.1 转换模块
直接面向用户，负责管理用户对工作流的描述，描述方式可以是dag，可以是文本。文本可以支持多种语法，如argo、fission workflow。
1. 负责文本与dag之间的转换
2. 负责将用户定义的对工作流的**功能态定义**转化为工作流引擎可执行的工作流的**运行态定义**

#### 2.1.1.2 运行模块
1. 负责将工作流的运行态定义发送到相应的工作流引擎
2. 负责定义用户所需的日志的数据结构，并从下层获取所需日志

## 2.2 工作流引擎层
该层负责根据用户层发送过来的工作流的运行态定义，逐个执行各个结点
1. 负责解析工作流的运行态定义，理解结点之间的依赖关系
2. 逐一执行满足条件的结点，向结点的执行层（函数引擎层/集群管理层）发送执行请求
3. 负责**在逻辑上**实现结点之间的数据传输，执行层执行结点运行请求时能顺利取到数据（可考虑将数据传输下移至执行层）
4. 负责从结点的执行层收集日志，并将日志向上传输至用户层。

## 2.3 函数引擎层
该层负责按函数的形式执行功能定义，提供函数执行的基础能力
1. 负责管理已有函数，做函数的新增、删除
2. 负责接收函数请求，并转发至相应的函数实例（负载均衡）
3. 负责函数实例数量的弹性伸缩
4.

## 2.4 集群管理层
负责管理结点和应用

### 2.4.1 运行环境管理模块
负责管理不同级别的运行环境池子，并将代码部署到满足其请求的运行环境上
1. 负责对运行环境进行升级降级
2. 负责选出符合代码要求的运行环境，并将代码部署到这上面
3. 

## 2.5 虚拟化层
在硬件之上提供环境隔离，隔离方式可以是虚拟机、容器、进程

## 2.6 基础硬件层


# 3 流程
![Pasted image 20230718103051.png](/img/user/08-Assets/Pasted%20image%2020230718103051.png)

# 4 数据结构
## 4.1 工作流结点 node

| 名称       | 描述         | 类型           | 备注                                                                                                           |
| ---------- | ------------ | -------------- | -------------------------------------------------------------------------------------------------------------- |
| Id         | 结点id       | int            |                                                                                                                |
| UserId     | 结点创建者id | int            |                                                                                                                |
| Available  | 结点可见范围 | enum           | 私有/公共                                                                                                      |
| Name       | 结点名称     | str            |                                                                                                                |
| Type       | 结点类型     | enum           | 初步需要实现的结点类型有：云函数结点、工作流结点，与此同时结点类型需要考虑拓展性(随时新增结点、修改结点的函数) | 
| InputNum   | 输入数据数量 | int            |                                                                                                                |
| OutputNum  | 输出数据数量 | int            |                                                                                                                |
| InputList  | 输入数据列表 | list(**data**) |                                                                                                                |
| OutputList | 输出数据列表 | list(**data**) |                                                                                                                |
| Desc       | 结点描述     | str            | 每种结点类型需要各自的结点解析器（如：云函数结点解析器、工作流结点解析器）                                                                               |
|            |              |                |                                                                                                                |


### 4.1.1 输入输出数据 data

| 名称  | 描述           | 类型 | 备注                                   |
| ----- | -------------- | ---- | -------------------------------------- |
| Type  | 输入数据的类型 | enum | 多种类型，对应不同的数据获取方式       |
| Name  | 输入数据的名称 | str  |                                        |
| Data  | 输入数据       | str  | 直接数据                               |
| Addr  | 输入数据的地址 | str  | 间接数据                               |
| Other | 其它信息       | str  | 作为拓展字段，为适应多种数据类型的需求 |

## 4.2 工作流 workflow

workflow继承于node

## 4.3 工作流记录

| 名称       | 描述           | 类型     | 备注                             |
| ---------- | -------------- | -------- | -------------------------------- |
| Id         | 记录id         | int      |                                  |
| WorkflowId | 工作流id       | int      |                                  |
| UserId     | 记录的创建者id | int      |                                  |
| Status     | 记录的状态     | enum     | Waiting/Running/Succeeded/Failed |
| CreateTime | 记录的创建时间 | datetime |                                  |
| UpdateTime | 记录的更新时间 | datetime |                                  |
| FinishTime | 记录的完成时间 | datetime |                                  |
|            |                |          |                                  |


# 5 接口
## 5.1 前端 <-> 工作流管理
### 5.1.1 工作流
#### 5.1.1.1 新建工作流
#### 5.1.1.2 删除工作流

### 5.1.2 修改图形
#### 5.1.2.1 添加结点
#### 5.1.2.2 删除结点
#### 5.1.2.3 添加依赖
#### 5.1.2.4 删除依赖

### 5.1.3 工作流记录
#### 5.1.3.1 运行工作流
#### 5.1.3.2 终止运行
#### 5.1.3.3 查看状态
#### 5.1.3.4 查看日志

## 5.2 工作流管理 <-> 工作流引擎
### 5.2.1 运行工作流
### 5.2.2 终止工作流运行
### 5.2.3 查看工作流运行状态/日志

## 5.3 工作流引擎 <-> 执行
### 5.3.1 执行结点
### 5.3.2 查看结点运行状态/日志/结果

# 6 Phase 1️⃣


# 7 Phase 2️⃣

# 8 Phase 3️⃣



