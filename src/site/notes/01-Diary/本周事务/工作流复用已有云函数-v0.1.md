---
{"dg-publish":true,"dg-permalink":"/01-diary/v0-1/entry-3/","permalink":"/01-diary/v0-1/entry-3/","title":"工作流复用已有云函数-v0.1"}
---



# 1 Background
目前的云函数部署方式是：在用户空间启动1个或多个最新版本云函数的副本，这些副本接收这个名字的云函数请求。

而在工作流中会引用云函数结点，那么在部署工作流时就要考虑工作流中的云函数是否要复用已经部署好的云函数副本，是直接将请求发送到已有的云函数副本（复用），还是为工作流中的每个云函数重新部署副本（不复用）。

经初步讨论确定使用复用方案，复用方案的优点如下：
1. 编辑工作流不需要重新配置云函数的资源	
2. 请求集中
	1. 整个系统的资源利用率更高
	2. 可以充分利用云函数框架的扩缩容机制
	3. 有利于充分发挥pipeline优势

# 2 Work
复用方案的工作量如下：
1. 将每个请求的**日志**区分开【easy】
2. 将每个请求所消耗的**资源**区分开
3. 在编辑工作流时指定云函数的版本，云函数的配置只读，若需要更改云函数的配置，需要跳转到云函数编辑界面新建版本【前端用户界面要支持，后端根据版本冷启动实例】
4. 支持运行多个版本的云函数，并且支持0副本【调研】

# 3 Scheme
## 3.1 基本修改
### 3.1.1 前端
在编辑工作流时指定云函数的版本，云函数的配置只读，若需要更改云函数的配置，需要跳转到云函数编辑界面新建版本
### 3.1.2 后端
工作流中云函数的结点信息包含版本，在后端运行云函数结点时向指定云函数的指定版本发送请求。（是否需要启动云函数新实例交给函数层去判断）

## 3.2 日志收集


## 3.3 资源监控


## 3.4 云函数改造
### 3.4.1 云函数支持同时部署多个版本
待讨论
技术上ok，工作量小【方案】
产品上流程修改【紫越】

### 3.4.2 云函数支持0副本
待评审
* [‍‌‍‌﻿‬⁣​⁡‍​‬‌﻿​⁣‬​‌⁢​‍⁣⁡﻿⁣‬⁣​​⁣⁣⁤​‍⁡​‍​⁣⁡⁡⁣﻿​⁤‬‬⁤⁡v1.3.0 支持函数实例弹性伸缩产品方案 - 飞书云文档](https://bvb1vt2cr9.feishu.cn/docx/KjyJdwRLWoO2LkxiFzMc59lhnDe)
* [Scale to Zero and Back Again with OpenFaaS | OpenFaaS - Serverless Functions Made Simple](https://www.openfaas.com/blog/zero-scale/)

# 4 Phase 1️⃣
两项云函数改造
前端基本修改
后端基本修改
日志收集？

# 5 Phase 2️⃣
资源监控

# 6 Phase 3️⃣



