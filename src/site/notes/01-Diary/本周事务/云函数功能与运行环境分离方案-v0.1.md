---
{"dg-publish":true,"dg-permalink":"/01-diary/v0-1/entry-5/","permalink":"/01-diary/v0-1/entry-5/","title":"云函数功能与运行环境分离方案-v0.1"}
---


# 1 Background
## 1.1 现状
现有的云工作空间平台中，新建云函数分为以下几步：
1. 创建
	1. 用模板创建 or 导入代码仓库
	2. 基础信息配置（name+desc）
2. 编码
	1. 简单模式（只有函数相关代码）
	2. 高级模式（包含函数相关代码和Dockerfile等环境代码）
3. 部署
	1. 挂载nfs
	2. cpu & 内存
	3. 环境变量
	4. 弹性伸缩
	5. 创建镜像+启动函数实例

## 1.2 问题
### 1.2.1 面向用户
1. 模板库无法涵盖所有需求（拓展性差）
2. 用户需要懂Dockerfile，并且需要花精力维护Dockerfile
3. 用户需要懂配置资源（cpu、内存、nfs等支撑性服务、弹性伸缩管理环境变量）

### 1.2.2 面向后端
1. 每次部署都需要按Dockerfile创建镜像，耗时耗资源
2. 镜像数量和空间占用爆炸性增长
3. 每次冷启动都需要传输大体积镜像（占用网络带宽+耗时），解压镜像（耗时），并启动容器（耗时）


综上，目前的方式从用户角度看操作繁琐，使用成本高，从后端角度看耗费大量资源（cpu、存储、网络带宽）并影响性能。

# 2 Target
1. 云函数的**功能代码**与**运行环境配置**分离
2. 用户在创建云函数之前需要创建新的运行环境（cpu、内存、Dockerfile）
3. 用户在创建云函数时需要从**运行环境库**中选择运行环境
4. 后端维护各种运行环境，做好运行时环境的升级和降级
5. 后端部署云函数时将云函数的功能代码发送到符合其需求的运行环境中，并运行代码

大方向是将功能代码运行所需的运行环境的管理下沉，可以是下沉到专门的运行环境开发者，也可以是底层系统。

# 3 Research
## 3.1 阿里云镜像加速方案
Dragonfly + Nydus
主要效果是减小容器启动所需时间，也可以减小镜像所占空间
* [Nydus —— 下一代容器镜像的探索实践 · SOFAStack](https://www.sofastack.tech/blog/nydus-exploratory-practice-of-next-generation-container-images/)
* [Nydus 镜像加速之内核演进之路 | Dragonfly](https://d7y.io/zh/blog/2022/06/06/evolution-of-nydus/)
* [容器镜像基础（nydus） - abin在路上 - 博客园](https://www.cnblogs.com/sctb/p/16583272.html)

## 3.2 阿里云创建函数
在创建函数时就需要指定运行环境
![Pasted image 20230711100947.png](/src/site/img/user/08-Assets/Pasted%20image%2020230711100947.png)
在编辑函数的时候只需要关注业务代码
![Pasted image 20230711101135.png](/src/site/img/user/08-Assets/Pasted%20image%2020230711101135.png)

# 4 Design
## 4.1 第1阶段 实现分离
1. 在前端抽离出**运行环境**这一层次
2. 运行环境的开发者根据Dockerfile**创建运行环境**
3. 后端根据运行环境的Dockerfile创建镜像
4. 云函数的开发者**写功能代码**，**选择运行环境**，并配置资源
5. 部署云函数时，后端根据云函数选择的运行环境调取相应的镜像并启动容器，启动后将代码拷贝到该容器，并开始运行代码。

## 4.2 第2阶段 初步形成环境包
1. 前端开启新的一种新建运行环境的方法，用户可以创建标签，每种标签对应某些Dockerfile命令，在某个运行环境中可以选择标签，并对这些标签排序。由此做到标签的复用。
2. 后端通过标签的复用，做到了更大程度上的镜像层的复用

## 4.3 第3阶段 形成环境包
1. 后端通过文件树对每种标签创建环境包【难点】
2. 后端可以根据对运行环境的需求，快速对运行环境的升级/降级（下载/卸载软件包）【p2p传输】
3. 每次部署新的运行环境不再需要从最初开始构建，只需要对已有的运行环境进行一系列升降级操作

## 4.4 第4阶段 运行环境完全智能化
1. 根据用户的功能代码直接选择or生成运行环境的配置文件，不再需要开发运行环境


# 5 Further
除容器以外的运行环境

# 6 Phase 1️⃣


# 7 Phase 2️⃣

# 8 Phase 3️⃣



